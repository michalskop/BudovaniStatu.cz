<?php
//first time it did not work

const API_DIR = '/home/shared/api.kohovolit.eu';
require 'ApiDirect.php';
error_reporting(E_ALL);
set_time_limit(0);
$ac = new ApiDirect('bs');

require 'simple_html_dom.php';
$dom = new simple_html_dom();

//$organizations = array//(117650,13693131,164801,18562,19453,19470,20338,20451,20478,20681,20869,209554,212423,213683,213691,213705,213713,213721,213730,215651,215660,215678,215686,215694,215708,215716,215724,215732,22985,23671,23817,23825,23833,24341,24384,24392,24406,24414,24422,24431,24449,24457,24465,24473,24490,24503,24511,24520,24538,24546,24554,24562,24571,24589,24597,24601,24627,24635,24643,24651,24660,24678,24686,24694,24716,24724,24732,24741,24759,24767,24775,24783,24791,24805,24821,24830,24848,24856,24864,24872,24881,24899,24902,24911,24937,24945,24953,24961,24970,24988,24996,25003,25011,25020,25038,25054,25062,25071,25089,25097,25101,25119,25127,25135,25143,25151,25160,25178,25186,25208,25216,25224,25232,25241,25259,25267,25275,25283,25291,25402,2542,25429,25593,25712,25844,26000,26018,26026,26034,26042,26051,26069,26077,26085,3352,411949,41693205,44225831,44993617,45251002,45332240,45769851,46494804,47236574,47608676,47609109,47609818,48133990,48134678,48135097,48135267,48135445,48135453,48136000,48136069,48136841,48137430,48510190,48513687,48549037,49370227,49467352,49534874,49625586,551023,560871,564222,60162694,60165171,60458500,60498021,60498030,60556552,61379425,61387584,62933591,63442868,63835827,63839407,638994,639613,640841,64106,64122654,64124533,64124584,64244300,64331857,64422402,64628019,64934276,65349423,65349563,65392191,65392205,65392213,65392221,65392230,65392248,65392256,65392264,65392272,65392281,65392299,65392302,65392311,6572,6599,66000769,66002222,66003008,67981801,68403569,6921,6947,6963,69797111,70106975,70565759,7064,70836981,70837627,70844844,70882525,70882835,70883378,70883611,70884099,70884561,70885184,70885371,70885869,70885940,70886288,70886300,70887306,70888060,70888744,70894451,70961808,70978956,70979057,70979090,70979146,70979201,
//70979391,70979464,70979821,70990948,71009159,71009167,71009183,71009191,71009213,71009221,71009248,71009256,71009264,71009281,71009299,71009302,71009311,71009345,71154639,71180397,71185186,71185194,71185208,71185216,71185224,71185232,71185241,71214011,71376500,72050250,72050365,72050501,72051612,72051795,72052147,72052767,72054506,75003716,75009561,75014149,75046962,75112779,75112817,75123924,75151472,75151481,75151499,75151502,75151511,75151529,75151537,75151545,75151898,75152304,75154960,849863,849871,93378,
$organizations = array (
1163,125911,13583212,13693824,13693972,137529,146005,151939,151971,169471,169692,170461,173452,179281,179876,179957,184055,18571,18589,18597,18601,18619,18627,18635,18643,18651,18660,18678,18686,18694,18708,18716,18724,18732,18741,18759,18767,18775,18783,18791,18805,18813,18821,18830,18848,18856,18864,18872,18881,18899,18902,18911,18929,189308,18937,18945,18953,18961,18970,18988,18996,19003,19011,19020,19038,190438,19046,19054,19062,19071,19089,19097,19101,19119,19127,191302,19135,19143,19151,19160,19178,19186,19194,19208,19216,192201,19224,19232,19241,19259,19267,19275,19283,19291,194247,194832,195723,20346,205591,206172,20729,207446,211427,211435,214167,225916,226009,226076,226122,226246,226360,226386,226408,23370,23418,23795,25861,25879,25887,25895,25909,25917,25933,25941,25968,26131,26140,26158,26174,26182,26239,26247,26255,26263,26271,26280,26298,26344,26361,26441,26450,26468,26484,26492,26514,26549,26557,26573,26581,26654,26689,26727,26751,26786,26832,26859,26875,26964,344010,361348,376558,389714,3966947,397181,3976947,3986947,410802,43965709,44117540,44847700,45250961,45251231,45251266,45251274,45251371,45251436,45251487,45251495,45251509,45251908,45772525,45806985,47224941,475904,476234,477087,477273,477397,477494,477532,479021,47935944,
480223,48133981,48328162,48328634,48342980,48455661,48511510,48682730,49558421,49624351,49708139,49752049,508021,508675,508691,508721,508764,509582,510416,510441,511803,512346,512451,515132,518514,519073,519677,519723,519731,521035,521086,521108,522848,523984,529397,529516,530123,554715,554758,554774,554898,554910,555096,555258,555720,556513,556556,557552,557561,557579,558231,559041,559199,559229,560014,560791,561118,562114,562394,562599,562700,566306,566578,566748,567051,567167,567639,574465,574562,575020,575470,575771,576166,582263,582301,583847,601276,62077490,62540122,62933582,62936506,63108089,63458608,638242,638251,638293,638307,638315,638323,638447,638471,638595,640832,640859,640867,640883,640891,640913,640921,64095479,64095487,640956,641022,641031,641057,641138,64227618,64631869,65025431,653489,653721,653861,653977,655040,655066,655198,655678,66000009,66192,662348,663204,663425,663875,665312,666602,666777,667501,668087,669865,669873,669881,669911,669920,670570,670723,673625,673633,673650,673668,673706,673714,673722,673757,673790,673838,673854,67555,67775802,67980074,6858,6866,6874,6882,6891,6904,69114331,6912,6939,70109800,70856508,70856788,73342,75064421,76678,76970,77127,77348,77917,77941,81779,835854,836249,836427,836524,836648,837318,842788,842796,842907,842915,842940,844390,844471,844489,844551,844586,844594,844713,845086,851019,86594346,868621,868728,868779,868809,873811,96717
);
$organizations = array(3966947,397181,3976947,3986947,410802,43965709,44117540,44847700,45250961,45251231,45251266,45251274,45251371,45251436,45251487,45251495,45251509,45251908,45772525,45806985,47224941,475904,476234,477087,477273,477397,477494,477532,479021,47935944,480223,48133981,48328162,48328634,48342980,48455661,48511510,48682730,49558421,49624351,49708139,49752049,508021,508675,508691,508721,508764,509582,510416,510441,511803,512346,512451,515132,518514,519073,519677,519723,519731,521035,521086,521108,522848,523984,529397,529516,530123,554715,554758,554774,554898,554910,555096,555258,555720,556513,556556,557552,557561,557579,558231,559041,559199,559229,560014,560791,561118,562114,562394,562599,562700,566306,566578,566748,567051,567167,567639,574465,574562,575020,575470,575771,576166,582263,582301,583847,601276,62077490,62540122,62933582,62936506,63108089,63458608,638242,638251,638293,638307,638315,638323,638447,638471,638595,640832,640859,640867,640883,640891,640913,640921,64095479,64095487,640956,641022,641031,641057,641138,64227618,64631869,65025431,653489,653721,653861,653977,655040,655066,655198,655678,66000009,66192,662348,663204,663425,663875,665312,666602,666777,667501,668087,669865,669873,669881,669911,669920,670570,670723,673625,673633,673650,673668,673706,673714,673722,673757,673790,673838,673854,67555,67775802,67980074,6858,6866,6874,6882,6891,6904,69114331,6912,6939,70109800,70856508,70856788,73342,75064421,76678,76970,77127,77348,77917,77941,81779,835854,836249,836427,836524,836648,837318,842788,842796,842907,842915,842940,844390,844471,844489,844551,844586,844594,844713,845086,851019,86594346,868621,868728,868779,868809,873811,96717);

$fields = array(
  'nazev'=>'',
  'forma'=>'',
  'nuts'=>'',
  'texttype'=>'0',
  'zanik'=>'0',
);

foreach ($organizations as $org_id) {
  $fields_string = '';
  $norg_id = n8($org_id);
  $fields['ico']=$norg_id;
  //url-ify the data for the POST
  foreach($fields as $key=>$value) { $fields_string .= $key.'='.$value.'&'; }
  rtrim($fields_string,'&');
  
  //grab czso.cz
  $grabber_options = array(
    array(CURLOPT_POST,count($fields)),
    array(CURLOPT_POSTFIELDS,$fields_string)
  );
  $html = iconv('iso-8859-2','utf-8//TRANSLIT',grabber('http://registry.czso.cz/irsw/hledat.jsp',$grabber_options));
  if (strpos($html,'Zadanému dotazu neodpovídá žádný záznam.') > 0) { //error in ICO
    $name = $org_id;
    $short_name = $org_id;
  } else {
	  $dom->load($html);
	  echo $org_id;
	  $name = $dom->find('table[class=tablist]',0)->find('td',1)->plaintext;
	  
	  //grab mfcr.cz
	   $html = grabber('http://wwwinfo.mfcr.cz/cgi-bin/ares/darv_res.cgi?ico='.$org_id.'&jazyk=cz&xml=1');
	   $dom->load($html);
	   $short_name = $dom->find('D:OF',0)->innertext;
   }
   echo $name.'#'.$short_name ;
   
   //insert into db
   //check if already exists
    $label_db = $ac->readOne('Organization',array('code' => $org_id)); 
    if (!$label_db) 
      $ac->create('Organization',array('code' => $org_id, 'name' =>$name, 'short_name' => $short_name));
   
}


function n8($in) {
  $len = strlen($in);
  for ($i = $len; $i < 8; $i++) {
    $in = '0'.$in; 
  }
  return $in;
}

/**
* curl downloader, with possible options
* @return html
* example:
* grabber('http://example.com',array(CURLOPT_TIMEOUT,180));
*/
function grabber($url,$options = array())
{
$ch = curl_init ();
curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt ($ch, CURLOPT_URL, $url);
curl_setopt ($ch, CURLOPT_TIMEOUT, 120);
if (count($options) > 0) {
foreach($options as $option) {
curl_setopt ($ch, $option[0], $option[1]);
}
}
return curl_exec($ch);
//curl_close ($ch);
}

?>;
